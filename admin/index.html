<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Festival Popup & Newsletter Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .festival-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .festival-card.active {
            border-color: #28a745;
            background: #d4edda;
        }

        .festival-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active {
            background: #28a745;
            color: white;
        }

        .status-inactive {
            background: #6c757d;
            color: white;
        }

        .color-picker-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .color-input {
            width: 100%;
            height: 50px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .current-festival {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .current-festival h3 {
            color: #d35400;
            margin-bottom: 10px;
        }

        .newsletter-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .checkbox-wrapper label {
            font-size: 16px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            margin-bottom: 0;
        }

        /* Loading spinner */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn.loading {
            opacity: 0.8;
            cursor: not-allowed;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .color-picker-group {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
            
        /* Title generation status styles */
        .title-status {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            color: #0066cc;
        }
        
        .title-status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .title-status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        /* Animation for loading spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéâ Festival Popup & Newsletter Admin</h1>
            <p>Manage your festival campaigns and email marketing</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="switchTab('popup-settings')">Popup Settings</button>
            <button class="tab-btn" onclick="switchTab('newsletter')">Newsletter</button>
            <button class="tab-btn" onclick="window.open('email-settings.html?shop=' + SHOP_DOMAIN, '_blank')">üìß Email Settings</button>
            <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2 class="section-title">Dashboard Overview</h2>
            
            <div id="current-festival-info" class="current-festival">
                <h3>Current Festival: Loading...</h3>
                <p>Festival information will appear here</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-subscribers">0</div>
                    <div class="stat-label">Total Subscribers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="festival-subscribers">0</div>
                    <div class="stat-label">Festival Subscribers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="blog-subscribers">0</div>
                    <div class="stat-label">Blog Subscribers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="newsletters-sent">0</div>
                    <div class="stat-label">Newsletters Sent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recent-subscribers">0</div>
                    <div class="stat-label">New This Month</div>
                </div>
            </div>
        </div>

        <!-- Popup Settings Tab -->
        <div id="popup-settings" class="tab-content">
            <h2 class="section-title">Festival Popup Configuration</h2>

            <form id="popup-form">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="popup-active">
                    <label for="popup-active">Enable Festival Popups</label>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="show-delay">Show Delay (ms)</label>
                        <input type="number" id="show-delay" value="3000" min="0">
                    </div>
                    <div class="form-group">
                        <label for="display-frequency">Display Frequency</label>
                        <select id="display-frequency">
                            <option value="once_per_session">Once Per Session</option>
                            <option value="once_per_day">Once Per Day</option>
                            <option value="always">Always Show</option>
                        </select>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px 0;">Festival Configurations</h3>
                
                <div style="margin-bottom: 20px;">
                    <button type="button" class="btn" onclick="addFestival()">Add New Festival</button>
                    <button type="submit" id="save-settings-btn" class="btn" style="margin-left: 10px;">Save Settings</button>
                    <button type="button" class="btn" onclick="showRegionalPreview()" style="margin-left: 10px; background: #3b82f6;">Preview Regional Variations</button>
                </div>
                
                <!-- Regional Preview Modal -->
                <div id="regional-preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
                    <div style="background: white; border-radius: 10px; padding: 30px; max-width: 90%; max-height: 90%; overflow: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>üó∫Ô∏è Regional Festival Variations</h2>
                            <button onclick="closeRegionalPreview()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="color: #666;">See how your festival will appear to users in different Indian states:</p>
                            <select id="preview-state-selector" onchange="updateRegionalPreview()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; margin-right: 10px;">
                                <option value="">Select a state...</option>
                                <option value="Delhi">Delhi</option>
                                <option value="West Bengal">West Bengal</option>
                                <option value="Maharashtra">Maharashtra</option>
                                <option value="Tamil Nadu">Tamil Nadu</option>
                                <option value="Karnataka">Karnataka</option>
                                <option value="Kerala">Kerala</option>
                                <option value="Gujarat">Gujarat</option>
                                <option value="Punjab">Punjab</option>
                                <option value="Haryana">Haryana</option>
                                <option value="Uttar Pradesh">Uttar Pradesh</option>
                                <option value="Rajasthan">Rajasthan</option>
                                <option value="Odisha">Odisha</option>
                                <option value="Assam">Assam</option>
                                <option value="Andhra Pradesh">Andhra Pradesh</option>
                                <option value="Telangana">Telangana</option>
                                <option value="Madhya Pradesh">Madhya Pradesh</option>
                                <option value="Chhattisgarh">Chhattisgarh</option>
                                <option value="Jharkhand">Jharkhand</option>
                                <option value="Goa">Goa</option>
                            </select>
                            <span id="preview-loading" style="display: none; color: #666;">Loading preview...</span>
                        </div>
                        
                        <div id="regional-preview-content" style="text-align: center; padding: 20px; border: 2px dashed #ddd; border-radius: 10px;">
                            <p style="color: #999;">Select a state to see regional variations</p>
                        </div>
                    </div>
                </div>
                
                <div id="festivals-container">
                    <!-- Dynamic festival cards will be inserted here -->
                </div>

                <!-- Blog Newsletter Popup Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Blog Newsletter Popup</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="blog_popup_enabled">Enable Blog Newsletter Popup</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="blog_popup_enabled" name="blog_popup_enabled">
                            </div>
                            <small class="form-text text-muted">Show newsletter popup on blog posts</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="blog_popup_delay">Popup Delay (seconds)</label>
                            <input type="number" class="form-control" id="blog_popup_delay" name="blog_popup_delay" min="1" max="30" value="3">
                            <small class="form-text text-muted">How long to wait before showing the popup</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="blog_popup_frequency">Display Frequency</label>
                            <select class="form-control" id="blog_popup_frequency" name="blog_popup_frequency">
                                <option value="once_per_session">Once per session</option>
                                <option value="once_per_day">Once per day</option>
                                <option value="always">Always show</option>
                            </select>
                            <small class="form-text text-muted">How often to show the popup to the same visitor</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="blog_title_prefix">Title Prefix</label>
                            <input type="text" class="form-control" id="blog_title_prefix" name="blog_title_prefix" value="DO YOU WANNA STAY UP TO DATE REGARDING">
                            <small class="form-text text-muted">The first part of the popup title</small>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Newsletter Tab -->
        <div id="newsletter" class="tab-content">
            <h2 class="section-title">Email Newsletter Management</h2>

            <!-- Auto-Newsletter Status Section -->
            <div class="auto-newsletter-section" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <h3 style="margin: 0 0 15px 0; color: #667eea;">ü§ñ Auto-Newsletter System</h3>
                <div id="auto-newsletter-status">
                    <p>Loading auto-newsletter status...</p>
                </div>
                <div id="manual-newsletter-triggers" style="margin-top: 15px;">
                    <!-- Manual triggers will be populated here -->
                </div>
            </div>

            <h3 style="margin: 20px 0; color: #333;">üìß Manual Newsletter Sending</h3>
            <form id="newsletter-form">
                <div class="form-group">
                    <label for="blog-title">
                        ü§ñ Smart Blog Title 
                        <span style="font-size: 12px; color: #666; font-weight: normal;">(Auto-generated when blog content is 50+ characters)</span>
                    </label>
                    <input type="text" id="blog-title" name="blog-title" title="AI will auto-generate this title based on your blog content" placeholder="AI will generate this automatically...">
                </div>

                <div class="form-group">
                    <label for="blog-content">üìù Blog Content</label>
                    <textarea id="blog-content" name="blog-content" title="Paste your blog content here - AI will auto-generate the title" rows="6" placeholder="Paste your blog content here (50+ characters to trigger AI title generation)..."></textarea>
                </div>

                <button type="submit" class="btn">Send Newsletter</button>
                
                <div id="title-generation-status" class="title-status" style="display: none; margin-top: 10px; padding: 10px; border-radius: 5px;">
                    <div class="loading-spinner" style="display: inline-block; margin-right: 10px;">
                        <div style="border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block;"></div>
                    </div>
                    <span id="title-status-text">Generating title with AI...</span>
                </div>

                <div id="newsletter-preview" class="newsletter-preview" style="display: none;">
                    <h4>Newsletter Preview</h4>
                    <div id="preview-content"></div>
                </div>
            </form>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <h2 class="section-title">Analytics & Reports</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="analytics-subscribers">0</div>
                    <div class="stat-label">Total Subscribers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="analytics-festival">0</div>
                    <div class="stat-label">Festival Subscribers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="analytics-blog">0</div>
                    <div class="stat-label">Blog Subscribers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="analytics-sent">0</div>
                    <div class="stat-label">Emails Sent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="analytics-recent">0</div>
                    <div class="stat-label">Recent Signups</div>
                </div>
            </div>

            <button class="btn" onclick="refreshAnalytics()">Refresh Data</button>
        </div>
    </div>

    <script>
        // Configuration - Auto-detect environment
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:3000' 
            : 'https://web-production-18602.up.railway.app';
        const SHOP_DOMAIN = 'test-festival-popup.myshopify.com'; // Fixed to match Shopify store

        // Debug information
        console.log('üîß Admin Panel Configuration:', {
            API_BASE_URL,
            SHOP_DOMAIN,
            timestamp: new Date().toISOString()
        });

        // Test API connectivity
        async function testAPIConnectivity() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                console.log('‚úÖ API Health Check:', data);
            } catch (error) {
                console.error('‚ùå API Health Check Failed:', error);
                console.log('üö® Make sure the server is running and accessible at:', API_BASE_URL);
            }
        }

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            testAPIConnectivity();
            loadDashboard();
            loadPopupSettings();
            setMinDateForInputs();
            
            // Add event listeners for auto-generation when fields change
            document.addEventListener('input', function(e) {
                if (e.target.matches('[data-field="offer"], [data-field="startDate"], [data-field="endDate"]')) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    console.log('üîÑ Field changed, checking for auto-generation:', e.target.getAttribute('data-field'));
                    checkAndAutoGenerate(index);
                }
            });

        });
        
        // Set minimum date to today for all date inputs
        function setMinDateForInputs() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.min = today;
            });
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load auto-newsletter status when newsletter tab is opened
            if (tabName === 'newsletter') {
                loadAutoNewsletterStatus();
            }
        }

        // Load dashboard data
        async function loadDashboard(forceRefresh = false) {
            try {
                // Add cache busting parameter if forced refresh
                const url = forceRefresh 
                    ? `${API_BASE_URL}/api/newsletter/analytics/${SHOP_DOMAIN}?t=${Date.now()}`
                    : `${API_BASE_URL}/api/newsletter/analytics/${SHOP_DOMAIN}`;
                
                const response = await fetch(url, {
                    cache: forceRefresh ? 'no-cache' : 'default',
                    headers: forceRefresh ? { 'Cache-Control': 'no-cache' } : {}
                });
                const data = await response.json();

                document.getElementById('total-subscribers').textContent = data.totalSubscribers || 0;
                document.getElementById('festival-subscribers').textContent = data.festivalSubscribers || 0;
                document.getElementById('blog-subscribers').textContent = data.blogSubscribers || 0;
                document.getElementById('newsletters-sent').textContent = data.blogPostsSent || 0;
                document.getElementById('recent-subscribers').textContent = data.recentSubscribers || 0;

                            // Update current festival info
            const festivalInfo = document.getElementById('current-festival-info');
            if (data.activeFestivals && data.activeFestivals.length > 0) {
                let festivalsHTML = '<h3 style="color: #2c3e50;">üéâ Active Festivals:</h3>';
                data.activeFestivals.forEach(festival => {
                    // Debug: Log festival color data
                    console.log('üé® Dashboard festival colors:', {
                        name: festival.name,
                        backgroundColor: festival.backgroundColor,
                        textColor: festival.textColor,
                        headerColor: festival.headerColor,
                        fullData: festival
                    });
                    
                    // Check if colors are undefined/null and log it
                    if (!festival.backgroundColor && !festival.bg) {
                        console.error('‚ùå NO BACKGROUND COLOR FOUND for festival:', festival.name, festival);
                    }
                    
                    // Force proper color values with stronger fallbacks
                    const bgColor = festival.backgroundColor || festival.bg || '#f0f0f0';
                    const txtColor = festival.textColor || festival.color || '#2c3e50';
                    
                    console.log('üé® Using colors:', { bg: bgColor, text: txtColor });
                    
                    festivalsHTML += `
                        <div style="margin: 10px 0; padding: 10px; background: ${bgColor} !important; border-radius: 5px;">
                            <strong style="color: ${txtColor} !important;">${festival.name}</strong><br>
                            <span style="color: ${txtColor} !important;">${festival.offer}</span><br>
                            <small style="color: ${txtColor} !important;">Code: ${festival.discountCode}</small>
                        </div>
                    `;
                });
                festivalInfo.innerHTML = festivalsHTML;
                // Remove the gray background override to show the festival colors
                festivalInfo.style.background = 'transparent';
            } else if (data.currentFestival) {
                festivalInfo.innerHTML = `
                    <h3 style="color: ${data.currentFestival.textColor || '#2c3e50'};">üéâ Current Festival: ${data.currentFestival.name}</h3>
                    <p style="color: ${data.currentFestival.textColor || '#2c3e50'};">${data.currentFestival.offer}</p>
                `;
                festivalInfo.style.background = data.currentFestival.backgroundColor || '#ffecd2';
            } else {
                festivalInfo.innerHTML = `
                    <h3>No Active Festival</h3>
                    <p>No festival is currently running. Configure popup settings to activate festivals.</p>
                    <small>Server Time: ${data.localTime || 'Unknown'}</small>
                `;
            }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load popup settings
        async function loadPopupSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/popup/${SHOP_DOMAIN}`);
                const settings = await response.json();

                if (settings) {
                    document.getElementById('popup-active').checked = settings.isActive;
                    document.getElementById('show-delay').value = settings.displaySettings?.showDelay || 3000;
                    document.getElementById('display-frequency').value = settings.displaySettings?.displayFrequency || 'once_per_session';

                    // Load blog newsletter popup settings
                    if (settings.blogPopupSettings) {
                        document.getElementById('blog_popup_enabled').checked = settings.blogPopupSettings.enabled !== false;
                        document.getElementById('blog_popup_delay').value = Math.round(settings.blogPopupSettings.delay / 1000) || 3;
                        document.getElementById('blog_popup_frequency').value = settings.blogPopupSettings.frequency || 'once_per_session';
                        document.getElementById('blog_title_prefix').value = settings.blogPopupSettings.titlePrefix || 'DO YOU WANNA STAY UP TO DATE REGARDING';
                    }

                    renderFestivals(settings.festivals || []);
                }
            } catch (error) {
                console.error('Error loading popup settings:', error);
            }
        }

        // Render festivals
        function renderFestivals(festivals) {
            const container = document.getElementById('festivals-container');
            const today = new Date().toISOString().split('T')[0];
            container.innerHTML = '';

            festivals.forEach((festival, index) => {
                const festivalCard = document.createElement('div');
                festivalCard.className = 'festival-card';
                festivalCard.innerHTML = `
                    <div class="festival-status status-active">Active</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Festival Name</label>
                            <input type="text" value="${festival.name}" data-field="name" data-index="${index}">
                        </div>
                        <div class="form-group">
                            <label>Offer Text</label>
                            <input type="text" value="${festival.offer}" data-field="offer" data-index="${index}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" value="${festival.startDate?.split('T')[0] || ''}" data-field="startDate" data-index="${index}" min="${today}">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" value="${festival.endDate?.split('T')[0] || ''}" data-field="endDate" data-index="${index}" min="${today}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Discount Code</label>
                            <input type="text" value="${festival.discountCode || ''}" data-field="discountCode" data-index="${index}">
                        </div>
                        <div class="form-group">
                            <label>Image URL (optional)</label>
                            <input type="url" value="${festival.imageUrl || ''}" data-field="imageUrl" data-index="${index}">
                        </div>
                    </div>
                    <div class="color-picker-group">
                        <div class="form-group">
                            <label>Background Color</label>
                            <input type="color" class="color-input" value="${festival.backgroundColor || '#d4574a'}" data-field="backgroundColor" data-index="${index}">
                        </div>
                        <div class="form-group">
                            <label>Text Color</label>
                            <input type="color" class="color-input" value="${festival.textColor || '#000000'}" data-field="textColor" data-index="${index}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>AI Background Image</label>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <input type="text" placeholder="e.g., 'festive monsoon celebration with blue water drops'" 
                                   value="${festival.backgroundImagePrompt || ''}" 
                                   data-field="backgroundImagePrompt" 
                                   data-index="${index}" 
                                   style="flex: 1;">
                            <button type="button" class="btn" onclick="generateBackgroundImage(${index})" style="white-space: nowrap;">
                                Generate Image
                            </button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Describe the background image you want (e.g., "festive decorations", "monsoon raindrops", "summer vibes")
                        </small>
                        ${festival.backgroundImageUrl ? `
                            <div style="margin-top: 10px;">
                                <img src="${festival.backgroundImageUrl}" 
                                     style="max-width: 200px; max-height: 100px; border-radius: 5px; border: 1px solid #ddd;"
                                     alt="Generated background">
                                <button type="button" class="btn btn-danger" onclick="removeBackgroundImage(${index})" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">
                                    Remove
                                </button>
                            </div>
                        ` : ''}
                        <input type="hidden" value="${festival.backgroundImageUrl || ''}" data-field="backgroundImageUrl" data-index="${index}">
                    </div>
                    <button type="button" class="btn btn-danger" onclick="removeFestival(${index})">Remove Festival</button>
                `;
                container.appendChild(festivalCard);
            });
        }

        // Add new smart festival (simplified interface)
        function addFestival() {
            const container = document.getElementById('festivals-container');
            const index = 0; // New festivals always get index 0 since they're inserted at the top
            const today = new Date().toISOString().split('T')[0];
            
            const festivalCard = document.createElement('div');
            festivalCard.className = 'festival-card';
            festivalCard.innerHTML = `
                <div class="festival-status status-inactive">New - AI Powered</div>
                <div class="ai-notice" style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="background: #4caf50; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">‚ú®</div>
                        <strong style="color: #2e7d32;">Auto-Smart Festival Creation</strong>
                    </div>
                    <p style="margin: 0; color: #388e3c; font-size: 14px;">
                        üé™ <strong>Festival Name:</strong> Auto-generated when you enter start date<br>
                        üé´ <strong>Discount Code:</strong> Auto-created from festival name and offer<br>
                        üé® <strong>Colors:</strong> Auto-extracted from generated background image<br>
                        üñºÔ∏è <strong>Background:</strong> AI-generated automatically using festival theme<br>
                        <br>
                        <strong style="color: #1b5e20;">üí° Just fill in the fields below and watch the magic happen!</strong>
                    </p>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Offer Text <span style="color: red;">*</span></label>
                        <input type="text" placeholder="e.g., 25% OFF Everything!" data-field="offer" data-index="${index}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date <span style="color: red;">*</span></label>
                        <input type="date" data-field="startDate" data-index="${index}" min="${today}" required>
                        <small style="color: #666;">Festival name will be generated based on this date</small>
                    </div>
                    <div class="form-group">
                        <label>End Date <span style="color: red;">*</span></label>
                        <input type="date" data-field="endDate" data-index="${index}" min="${today}" required>
                    </div>
                </div>

                
                <!-- AI Generated Fields (Read-only) -->
                <div class="ai-generated-fields" style="background: #f5f5f5; border-radius: 8px; padding: 15px; margin: 15px 0;">
                    <h4 style="margin: 0 0 15px 0; color: #555; display: flex; align-items: center; gap: 8px;">
                        <span style="background: #4caf50; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;">AI</span>
                        Auto-Generated Content
                    </h4>
                    
                    <div class="form-group">
                        <label>Festival Name</label>
                        <input type="text" data-field="name" data-index="${index}" readonly placeholder="Will be generated from date..." style="background: #fff; border: 1px solid #ddd;">
                    </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Background Color</label>
                        <input type="color" class="color-input" data-field="backgroundColor" data-index="${index}" readonly style="background: #fff; border: 1px solid #ddd;" value="#d4574a">
                        <small style="color: #666;">Main color extracted from generated image</small>
                    </div>
                    <div class="form-group">
                        <label>Text Color</label>
                        <input type="color" class="color-input" data-field="textColor" data-index="${index}" readonly style="background: #fff; border: 1px solid #ddd;" value="#000000">
                        <small style="color: #666;">Auto-optimized for contrast with background image</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Header Color</label>
                        <input type="color" class="color-input" data-field="headerColor" data-index="${index}" readonly style="background: #fff; border: 1px solid #ddd;" value="#1a73e8">
                        <small style="color: #666;">Primary color from generated image</small>
                    </div>
                </div>
                    
                    <div class="form-group">
                        <label>Discount Code</label>
                        <input type="text" data-field="discountCode" data-index="${index}" readonly placeholder="Will be generated from festival name and offer..." style="background: #fff; border: 1px solid #ddd;">
                        <small style="color: #666;">Auto-generated from festival name and offer text</small>
                    </div>
                    
                <div class="form-group">
                    <label>AI Background Image</label>
                        <div class="image-preview-container" style="min-height: 60px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #fafafa;">
                            <span style="color: #999;">Background image will be generated automatically</span>
                    </div>
                    <input type="hidden" data-field="backgroundImageUrl" data-index="${index}">
                        <input type="hidden" data-field="backgroundImagePrompt" data-index="${index}">
                        <input type="hidden" data-field="headerColor" data-index="${index}">
                </div>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" onclick="removeFestival(${index})">Remove</button>
                </div>
            `;
            // Insert at the beginning (top) of the container instead of appending to the end
            container.insertBefore(festivalCard, container.firstChild);
            
            // Re-index all festival cards since we inserted at the top
            Array.from(container.children).forEach((card, newIndex) => {
                card.querySelectorAll('[data-index]').forEach(input => {
                    input.setAttribute('data-index', newIndex);
                });
                // Update onclick handlers that reference the index
                const removeButton = card.querySelector('button[onclick*="removeFestival"]');
                if (removeButton) {
                    removeButton.setAttribute('onclick', `removeFestival(${newIndex})`);
                }
            });
        }

        // Remove festival
        function removeFestival(index) {
            const container = document.getElementById('festivals-container');
            container.children[index].remove();
            // Re-index remaining cards
            Array.from(container.children).forEach((card, newIndex) => {
                card.querySelectorAll('[data-index]').forEach(input => {
                    input.setAttribute('data-index', newIndex);
                });
            });
        }

        // Generate background image using AI
        async function generateBackgroundImage(index) {
            const container = document.getElementById('festivals-container');
            const card = container.children[index];
            const promptInput = card.querySelector('[data-field="backgroundImagePrompt"]');
            const urlInput = card.querySelector('[data-field="backgroundImageUrl"]');
            const generateButton = card.querySelector('button[onclick*="generateBackgroundImage"]');
            
            const prompt = promptInput.value.trim();
            
            if (!prompt) {
                showMessage('Please enter a description for the background image', 'error');
                return;
            }
            
            // Show loading state
            const originalText = generateButton.textContent;
            generateButton.textContent = 'Generating...';
            generateButton.disabled = true;
            
            try {
                console.log('üé® Generating image for prompt:', prompt);
                
                const response = await fetch(`${API_BASE_URL}/api/generate-image`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    urlInput.value = result.imageUrl;
                    
                    // Show the generated image
                    const existingPreview = card.querySelector('.image-preview');
                    if (existingPreview) {
                        existingPreview.remove();
                    }
                    
                    const imagePreview = document.createElement('div');
                    imagePreview.className = 'image-preview';
                    imagePreview.style.marginTop = '10px';
                    imagePreview.innerHTML = `
                        <img src="${result.imageUrl}" 
                             style="max-width: 200px; max-height: 100px; border-radius: 5px; border: 1px solid #ddd;"
                             alt="Generated background">
                        <button type="button" class="btn btn-danger" onclick="removeBackgroundImage(${index})" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">
                            Remove
                        </button>
                    `;
                    
                    promptInput.parentNode.appendChild(imagePreview);
                    
                    showMessage(result.message || 'Background image generated successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to generate image');
                }
                
            } catch (error) {
                console.error('Error generating image:', error);
                showMessage(`Failed to generate image: ${error.message}`, 'error');
                
                // Try alternative endpoint as fallback
                try {
                    const fallbackResponse = await fetch(`${API_BASE_URL}/api/generate-image-alt`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    
                    const fallbackResult = await fallbackResponse.json();
                    
                    if (fallbackResult.success) {
                        urlInput.value = fallbackResult.imageUrl;
                        
                        // Show the fallback image
                        const existingPreview = card.querySelector('.image-preview');
                        if (existingPreview) {
                            existingPreview.remove();
                        }
                        
                        const imagePreview = document.createElement('div');
                        imagePreview.className = 'image-preview';
                        imagePreview.style.marginTop = '10px';
                        imagePreview.innerHTML = `
                            <img src="${fallbackResult.imageUrl}" 
                                 style="max-width: 200px; max-height: 100px; border-radius: 5px; border: 1px solid #ddd;"
                                 alt="Generated background">
                            <button type="button" class="btn btn-danger" onclick="removeBackgroundImage(${index})" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">
                                Remove
                            </button>
                        `;
                        
                        promptInput.parentNode.appendChild(imagePreview);
                        
                        showMessage('Background image generated using fallback service!', 'success');
                    }
                } catch (fallbackError) {
                    console.error('Fallback image generation also failed:', fallbackError);
                    showMessage('Image generation services are temporarily unavailable', 'error');
                }
            } finally {
                // Restore button state
                generateButton.textContent = originalText;
                generateButton.disabled = false;
            }
        }

        // Smart Festival Generation Functions
        
        // Check if all required fields are filled and auto-generate
        function checkAndAutoGenerate(index) {
            const container = document.getElementById('festivals-container');
            if (!container) return;
            
            const card = container.children[index];
            if (!card) return;
            
            const offerInput = card.querySelector('[data-field="offer"]');
            const startDateInput = card.querySelector('[data-field="startDate"]');
            const endDateInput = card.querySelector('[data-field="endDate"]');
            
            // Check if all required fields are filled
            const offer = offerInput?.value?.trim();
            const startDate = startDateInput?.value;
            const endDate = endDateInput?.value;
            
            if (offer && startDate && endDate && new Date(startDate) < new Date(endDate)) {
                console.log('‚úÖ All required fields filled, auto-generating festival...');
                
                // Add a small delay to avoid rapid-fire API calls while user is typing
                clearTimeout(window.autoGenerateTimeout);
                window.autoGenerateTimeout = setTimeout(() => {
                    generateSmartFestival(index);
                }, 1000); // 1 second delay
            } else {
                console.log('‚è≥ Waiting for all required fields to be filled');
            }
        }

        // Generate complete smart festival
        async function generateSmartFestival(index) {
            console.log('ü§ñ generateSmartFestival called with index:', index);
            
            const container = document.getElementById('festivals-container');
            if (!container) {
                console.error('‚ùå festivals-container not found');
                showMessage('Error: Container not found', 'error');
                return;
            }
            
            const card = container.children[index];
            if (!card) {
                console.error('‚ùå Festival card at index', index, 'not found');
                showMessage('Error: Festival card not found', 'error');
                return;
            }
            
            // Check if festival is already being generated to avoid duplicate calls
            if (card.classList.contains('generating')) {
                console.log('‚è≠Ô∏è Festival already being generated, skipping...');
                return;
            }
            
            card.classList.add('generating');
            
            // Get required fields with error checking
            const offerInput = card.querySelector('[data-field="offer"]');
            const startDateInput = card.querySelector('[data-field="startDate"]');
            const endDateInput = card.querySelector('[data-field="endDate"]');
            
            console.log('üîç Form elements found:', {
                offerInput: !!offerInput,
                startDateInput: !!startDateInput,
                endDateInput: !!endDateInput
            });
            
            if (!offerInput || !startDateInput || !endDateInput) {
                console.error('‚ùå Required form elements not found');
                showMessage('Error: Required form elements not found', 'error');
                return;
            }
            
            const offer = offerInput.value.trim();
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            // Validate required fields
            if (!offer || !startDate || !endDate) {
                showMessage('Please fill in all required fields (marked with *)', 'error');
                return;
            }
            
            if (new Date(startDate) >= new Date(endDate)) {
                showMessage('End date must be after start date', 'error');
                return;
            }
            
            // Show loading state in the festival name field
            const nameInput = card.querySelector('[data-field="name"]');
            const originalNamePlaceholder = nameInput.placeholder;
            nameInput.placeholder = 'ü§ñ Generating festival name...';
            
            // Add loading overlay to AI fields section
            const aiFields = card.querySelector('.ai-generated-fields');
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
                z-index: 10;
            `;
            loadingOverlay.innerHTML = `
                <div style="text-align: center;">
                    <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2196f3; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                    <div style="color: #2196f3; font-weight: bold;">AI Generating Festival...</div>
                </div>
            `;
            aiFields.style.position = 'relative';
            aiFields.appendChild(loadingOverlay);
            
            try {
                console.log('ü§ñ Creating smart festival...');
                
                const response = await fetch(`${API_BASE_URL}/api/create-smart-festival`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shopDomain: SHOP_DOMAIN,
                        offer,
                        startDate,
                        endDate
                    })
                });
                
                console.log('üåê Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Response error:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ API Response:', result);
                
                if (result.success) {
                    const festival = result.festival;
                    
                    // Update all fields with generated data - with error checking
                    const nameField = card.querySelector('[data-field="name"]');
                    const discountCodeField = card.querySelector('[data-field="discountCode"]');
                    const textColorField = card.querySelector('[data-field="textColor"]');
                    const backgroundColorField = card.querySelector('[data-field="backgroundColor"]');
                    const backgroundImageUrlField = card.querySelector('[data-field="backgroundImageUrl"]');
                    const backgroundImagePromptField = card.querySelector('[data-field="backgroundImagePrompt"]');
                    const headerColorField = card.querySelector('[data-field="headerColor"]');
                    
                    console.log('üîç Field availability check:', {
                        nameField: !!nameField,
                        discountCodeField: !!discountCodeField,
                        textColorField: !!textColorField,
                        backgroundColorField: !!backgroundColorField,
                        backgroundImageUrlField: !!backgroundImageUrlField,
                        backgroundImagePromptField: !!backgroundImagePromptField,
                        headerColorField: !!headerColorField
                    });
                    
                    // Safely update fields that exist
                    if (nameField) nameField.value = festival.name;
                    if (discountCodeField) discountCodeField.value = festival.discountCode;
                    if (textColorField) textColorField.value = festival.textColor;
                    if (backgroundColorField) backgroundColorField.value = festival.backgroundColor;
                    if (backgroundImageUrlField) backgroundImageUrlField.value = festival.backgroundImageUrl || '';
                    if (backgroundImagePromptField) backgroundImagePromptField.value = festival.backgroundImagePrompt || '';
                    if (headerColorField) headerColorField.value = festival.headerColor;
                    
                    console.log('üé® Updated festival colors:', {
                        backgroundColor: festival.backgroundColor,
                        textColor: festival.textColor,
                        headerColor: festival.headerColor
                    });
                    
                    // Update image preview
                    const imagePreviewContainer = card.querySelector('.image-preview-container');
                    if (festival.backgroundImageUrl) {
                        imagePreviewContainer.innerHTML = `
                            <div style="position: relative;">
                                <img src="${festival.backgroundImageUrl}" 
                                     style="max-width: 100%; max-height: 120px; border-radius: 5px;"
                                     alt="Generated background">
                                <div style="position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">
                                    Colors Auto-Extracted
                                </div>
                            </div>
                        `;
                        imagePreviewContainer.style.background = '#fff';
                        imagePreviewContainer.style.padding = '10px';
                    } else {
                        imagePreviewContainer.innerHTML = '<span style="color: #ff9800;">Background image generation in progress...</span>';
                    }
                    
                    // Update status
                    const statusElement = card.querySelector('.festival-status');
                    statusElement.textContent = 'Generated - Ready to Save';
                    statusElement.className = 'festival-status status-active';
                    
                    // Style the generated fields with visual indicators - with safety checks
                    if (nameField) {
                        nameField.style.color = '#4caf50';
                        nameField.style.fontWeight = 'bold';
                    }
                    
                    if (discountCodeField) {
                        discountCodeField.style.color = '#4caf50';
                        discountCodeField.style.fontWeight = 'bold';
                        discountCodeField.style.border = '2px solid #4caf50';
                    }
                    
                    // Highlight color fields that were auto-extracted
                    if (textColorField) textColorField.style.border = '2px solid #4caf50';
                    if (backgroundColorField) backgroundColorField.style.border = '2px solid #4caf50';
                    if (headerColorField) headerColorField.style.border = '2px solid #4caf50';
                    
                    // Add success message with color details
                    const colorInfo = festival.imageColors ? 
                        `Colors extracted: Background(${festival.backgroundColor}), Text(${festival.textColor}), Header(${festival.headerColor})` : 
                        'Using fallback colors';
                    
                    showMessage(`üéâ Festival "${festival.name}" auto-generated successfully! ${colorInfo}`, 'success');
                    
                } else {
                    throw new Error(result.error || 'Failed to generate smart festival');
                }
                
            } catch (error) {
                console.error('Error generating smart festival:', error);
                showMessage(`Failed to auto-generate festival: ${error.message}`, 'error');
                
                // Remove loading state and show error in preview
                const imagePreviewContainer = card.querySelector('.image-preview-container');
                imagePreviewContainer.innerHTML = '<span style="color: #f44336;">Auto-generation failed. Please check your inputs.</span>';
                
            } finally {
                // Remove loading overlay safely
                if (loadingOverlay && loadingOverlay.parentNode) {
                    loadingOverlay.remove();
                }
                if (aiFields) {
                    aiFields.style.position = '';
                }
                
                // Restore placeholder and remove generating class
                const nameInput = card.querySelector('[data-field="name"]');
                if (nameInput) {
                    nameInput.placeholder = originalNamePlaceholder || 'Festival name will be generated';
                }
                card.classList.remove('generating');
            }
        }
        
        // Legacy function - kept for backward compatibility
        function removeBackgroundImage(index) {
            const container = document.getElementById('festivals-container');
            const card = container.children[index];
            const urlInput = card.querySelector('[data-field="backgroundImageUrl"]');
            const imagePreview = card.querySelector('.image-preview');
            
            urlInput.value = '';
            if (imagePreview) {
                imagePreview.remove();
            }
            
            showMessage('Background image removed', 'success');
        }

        // Save popup settings
        document.getElementById('popup-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading spinner on save button
            const saveBtn = document.getElementById('save-settings-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="spinner"></span>Saving & Reloading...';
            saveBtn.classList.add('loading');
            
            const festivals = [];
            const festivalCards = document.querySelectorAll('.festival-card');
            const today = new Date().toISOString().split('T')[0];
            
            // Validate dates
            let hasError = false;
            festivalCards.forEach(card => {
                const festival = {};
                card.querySelectorAll('[data-field]').forEach(input => {
                    const field = input.getAttribute('data-field');
                    festival[field] = input.value;
                });
                
                // Validate dates are not in the past
                if (festival.startDate && festival.startDate < today) {
                    showMessage('Start date cannot be in the past', 'error');
                    hasError = true;
                    return;
                }
                if (festival.endDate && festival.endDate < today) {
                    showMessage('End date cannot be in the past', 'error');
                    hasError = true;
                    return;
                }
                if (festival.startDate && festival.endDate && festival.endDate < festival.startDate) {
                    showMessage('End date cannot be before start date', 'error');
                    hasError = true;
                    return;
                }
                
                festivals.push(festival);
            });
            
            if (hasError) {
                // Restore button state on validation error
                saveBtn.innerHTML = originalText;
                saveBtn.classList.remove('loading');
                return;
            }

            const settings = {
                isActive: document.getElementById('popup-active').checked,
                festivals: festivals,
                displaySettings: {
                    showDelay: parseInt(document.getElementById('show-delay').value),
                    displayFrequency: document.getElementById('display-frequency').value,
                    position: 'center'
                },
                blogPopupSettings: {
                    enabled: document.getElementById('blog_popup_enabled').checked,
                    delay: parseInt(document.getElementById('blog_popup_delay').value) * 1000,
                    frequency: document.getElementById('blog_popup_frequency').value,
                    titlePrefix: document.getElementById('blog_title_prefix').value
                }
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/popup/${SHOP_DOMAIN}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showMessage('Popup settings saved successfully! Reloading page...', 'success');
                    
                    // Refresh dashboard data multiple times with forced cache busting
                    setTimeout(async () => {
                        await loadDashboard(true); // Force refresh
                    }, 200);
                    
                    setTimeout(async () => {
                        await loadDashboard(true); // Force refresh
                    }, 800);
                    
                    setTimeout(async () => {
                        await loadDashboard(true); // Third refresh for stubborn cases
                    }, 1200);
                    
                    // Check if colors are properly displayed and force reload if not
                    setTimeout(() => {
                        const festivalDivs = document.querySelectorAll('[style*="background:"]');
                        let hasProperColors = false;
                        
                        festivalDivs.forEach(div => {
                            const style = div.getAttribute('style');
                            if (style && style.includes('background:') && !style.includes('#f0f0f0')) {
                                hasProperColors = true;
                            }
                        });
                        
                        if (!hasProperColors) {
                            console.log('üîÑ Colors not properly displayed, forcing immediate reload...');
                            window.location.reload();
                        }
                    }, 1000);
                    
                    // Then auto-reload page after a short delay to show the success message
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showMessage('Error saving settings', 'error');
                    // Restore button state on error
                    saveBtn.innerHTML = originalText;
                    saveBtn.classList.remove('loading');
                }
            } catch (error) {
                console.error('Error saving popup settings:', error);
                showMessage('Error saving settings', 'error');
                // Restore button state on error
                saveBtn.innerHTML = originalText;
                saveBtn.classList.remove('loading');
            }
        });

        // Auto-generate title with AI when blog content changes
        let titleGenerationTimeout;
        
        async function autoGenerateTitle() {
            const content = document.getElementById('blog-content').value;
            const titleInput = document.getElementById('blog-title');
            
            if (!content.trim() || content.trim().length < 50) {
                return; // Don't generate title for short content
            }
            
            // Clear existing timeout
            if (titleGenerationTimeout) {
                clearTimeout(titleGenerationTimeout);
            }

            // Show loading status
            showTitleGenerationStatus('loading', 'Generating title with AI...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate-dynamic-title`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        blogContent: content,
                        shopDomain: SHOP_DOMAIN
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    titleInput.value = result.title;
                    
                    const statusMessage = result.fallback ? 
                        'Title generated (using fallback method)' : 
                        `Title generated with AI${result.festivalContext ? ` (Festival context: ${result.festivalContext})` : ''}`;
                    
                    showTitleGenerationStatus('success', statusMessage);
                    
                    // Auto-hide success message after 3 seconds
                    setTimeout(() => {
                        hideTitleGenerationStatus();
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Failed to generate title');
                }
                
            } catch (error) {
                console.error('Title generation error:', error);
                showTitleGenerationStatus('error', 'Failed to generate title. You can enter one manually.');
                
                // Auto-hide error message after 5 seconds
                setTimeout(() => {
                    hideTitleGenerationStatus();
                }, 5000);
            }
        }
        
        function showTitleGenerationStatus(type, message) {
            const statusDiv = document.getElementById('title-generation-status');
            const statusText = document.getElementById('title-status-text');
            const spinner = statusDiv.querySelector('.loading-spinner');
            
            statusDiv.className = `title-status ${type}`;
            statusText.textContent = message;
            
            if (type === 'loading') {
                spinner.style.display = 'inline-block';
            } else {
                spinner.style.display = 'none';
            }
            
            statusDiv.style.display = 'block';
        }
        
        function hideTitleGenerationStatus() {
            document.getElementById('title-generation-status').style.display = 'none';
        }

        // Auto-generate title when blog content changes (with debounce)
        document.getElementById('blog-content').addEventListener('input', function() {
            const content = this.value.trim();
            const threshold = 50;
            
            // Clear existing timeout
            if (titleGenerationTimeout) {
                clearTimeout(titleGenerationTimeout);
            }
            
            // Hide any existing status
            hideTitleGenerationStatus();
            
            // Show character count indicator
            updateCharacterCountIndicator(content.length, threshold);
            
            // Set new timeout to generate title after user stops typing for 2 seconds
            if (content.length >= threshold) {
                titleGenerationTimeout = setTimeout(() => {
                    autoGenerateTitle();
                }, 2000);
            }
        });
        
        function updateCharacterCountIndicator(currentLength, threshold) {
            const titleLabel = document.querySelector('label[for="blog-title"]');
            const indicator = titleLabel.querySelector('.char-indicator') || document.createElement('span');
            
            if (!titleLabel.querySelector('.char-indicator')) {
                indicator.className = 'char-indicator';
                indicator.style.cssText = 'font-size: 11px; margin-left: 8px; padding: 2px 6px; border-radius: 3px; font-weight: normal;';
                titleLabel.appendChild(indicator);
            }
            
            if (currentLength >= threshold) {
                indicator.textContent = `‚úÖ Ready for AI (${currentLength} chars)`;
                indicator.style.background = '#d4edda';
                indicator.style.color = '#155724';
            } else if (currentLength > 0) {
                indicator.textContent = `${threshold - currentLength} more chars needed`;
                indicator.style.background = '#fff3cd';
                indicator.style.color = '#856404';
            } else {
                indicator.textContent = '';
                indicator.style.background = 'transparent';
            }
        }

        // Send newsletter
        document.getElementById('newsletter-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const blogTitle = document.getElementById('blog-title').value;
            const blogContent = document.getElementById('blog-content').value;

            if (!blogTitle || !blogContent) {
                showMessage('Please fill in both title and content', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/newsletter/send-blog`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shopDomain: SHOP_DOMAIN,
                        blogTitle,
                        blogContent
                    })
                });

                const result = await response.json();

                if (result.success) {
                    let message = `Newsletter sent successfully with title: "${result.dynamicTitle}"`;
                    
                    if (result.emailsSent !== undefined) {
                        message = `Newsletter sent to ${result.emailsSent} subscribers with title: "${result.dynamicTitle}"`;
                    }
                    
                    if (result.warning) {
                        message += `\n‚ö†Ô∏è ${result.warning}`;
                    }
                    
                    showMessage(message, 'success');
                    loadDashboard(); // Refresh stats
                } else {
                    let errorMessage = result.error || 'Error sending newsletter';
                    
                    // Show specific error for email configuration
                    if (result.needsEmailConfig) {
                        errorMessage = '‚ùå Email not configured!\n\nFor Gmail users:\n1. Enable 2-Factor Authentication\n2. Generate App Password at: https://myaccount.google.com/apppasswords\n3. Create .env file with:\n   EMAIL_USER=your-email@gmail.com\n   EMAIL_PASSWORD=your-16-character-app-password\n4. Restart the server\n\nFor other providers, use regular password.';
                        
                        if (result.instructions) {
                            errorMessage += '\n\nDetailed instructions:\n';
                            Object.entries(result.instructions).forEach(([provider, instruction]) => {
                                errorMessage += `${provider.toUpperCase()}: ${instruction}\n`;
                            });
                        }
                    }
                    
                    // Show detailed email failure info
                    if (result.emailsFailed > 0) {
                        errorMessage += `\n\nüìä Failed to send ${result.emailsFailed} emails. Check server console for details.`;
                    }
                    
                    showMessage(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error sending newsletter:', error);
                showMessage('Error sending newsletter', 'error');
            }
        });

        // Refresh analytics
        async function refreshAnalytics() {
            await loadDashboard();
            
            // Update analytics tab specifically
            document.getElementById('analytics-subscribers').textContent = 
                document.getElementById('total-subscribers').textContent;
            document.getElementById('analytics-festival').textContent = 
                document.getElementById('festival-subscribers').textContent;
            document.getElementById('analytics-blog').textContent = 
                document.getElementById('blog-subscribers').textContent;
            document.getElementById('analytics-sent').textContent = 
                document.getElementById('newsletters-sent').textContent;
            document.getElementById('analytics-recent').textContent = 
                document.getElementById('recent-subscribers').textContent;
                
            showMessage('Analytics refreshed!', 'success');
        }

        // Show message
        function showMessage(message, type) {
            // Remove existing messages
            document.querySelectorAll('.success-message, .error-message').forEach(el => el.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(messageDiv, document.querySelector('.tabs'));
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Load auto-newsletter status
        async function loadAutoNewsletterStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/newsletter/auto-status/${SHOP_DOMAIN}`);
                const data = await response.json();
                
                if (data.success) {
                    displayAutoNewsletterStatus(data);
                } else {
                    document.getElementById('auto-newsletter-status').innerHTML = 
                        '<p style="color: #e74c3c;">‚ùå Failed to load auto-newsletter status</p>';
                }
            } catch (error) {
                console.error('Error loading auto-newsletter status:', error);
                document.getElementById('auto-newsletter-status').innerHTML = 
                    '<p style="color: #e74c3c;">‚ùå Error loading auto-newsletter status</p>';
            }
        }
        
        // Display auto-newsletter status
        function displayAutoNewsletterStatus(data) {
            const statusDiv = document.getElementById('auto-newsletter-status');
            const triggersDiv = document.getElementById('manual-newsletter-triggers');
            
            // Status summary
            let statusHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <h4 style="margin: 0 0 5px 0; color: #4caf50;">üìß Festival Subscribers</h4>
                        <p style="margin: 0; font-size: 18px; font-weight: bold;">${data.subscribersCount}</p>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <h4 style="margin: 0 0 5px 0; color: #2196f3;">üé™ Active Festivals</h4>
                        <p style="margin: 0; font-size: 18px; font-weight: bold;">${data.activeFestivals.length}</p>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <h4 style="margin: 0 0 5px 0; color: #ff9800;">ü§ñ Auto Newsletters</h4>
                        <p style="margin: 0; font-size: 18px; font-weight: bold;">${data.autoNewsletters.length}</p>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${data.emailConfigured ? '#4caf50' : '#f44336'};">
                        <h4 style="margin: 0 0 5px 0; color: ${data.emailConfigured ? '#4caf50' : '#f44336'};">‚öôÔ∏è Email Config</h4>
                        <p style="margin: 0; font-size: 14px; font-weight: bold;">${data.emailConfigured ? '‚úÖ Configured' : '‚ùå Not Configured'}</p>
                    </div>
                </div>
            `;
            
            // Auto-newsletters history
            if (data.autoNewsletters.length > 0) {
                statusHTML += `
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">üìú Recent Auto-Newsletters</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                `;
                
                data.autoNewsletters.forEach(newsletter => {
                    const date = new Date(newsletter.publishedAt).toLocaleDateString('en-IN');
                    const time = new Date(newsletter.publishedAt).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                    statusHTML += `
                        <div style="padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <strong>${newsletter.title}</strong><br>
                                <small style="color: #666;">${date} at ${time}</small>
                            </div>
                            <div style="color: ${newsletter.sent ? '#4caf50' : '#f44336'};">
                                ${newsletter.sent ? '‚úÖ Sent' : '‚ùå Failed'}
                            </div>
                        </div>
                    `;
                });
                
                statusHTML += `
                        </div>
                    </div>
                `;
            }
            
            statusDiv.innerHTML = statusHTML;
            
            // Manual trigger buttons for active festivals
            let triggersHTML = '';
            if (data.activeFestivals.length > 0) {
                triggersHTML = `
                    <h4 style="margin: 0 0 10px 0; color: #333;">üöÄ Manual Newsletter Triggers</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                `;
                
                data.activeFestivals.forEach(festival => {
                    triggersHTML += `
                        <button type="button" class="btn" 
                                onclick="triggerFestivalNewsletter('${festival.id}')" 
                                style="background: ${festival.backgroundColor || '#667eea'}; color: ${festival.textColor || '#ffffff'}; border: none;">
                            üìß Send ${festival.name} Newsletter
                        </button>
                    `;
                });
                
                triggersHTML += `</div>`;
            } else if (data.emailConfigured) {
                triggersHTML = '<p style="color: #666; font-style: italic;">No active festivals available for newsletter generation.</p>';
            } else {
                triggersHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Email Configuration Required</h4>
                        <p style="margin: 0; color: #856404;">
                            Auto-newsletters are disabled because email is not configured. 
                            Please set up EMAIL_USER and EMAIL_PASSWORD in your .env file.
                        </p>
                    </div>
                `;
            }
            
            triggersDiv.innerHTML = triggersHTML;
        }
        
        // Manual trigger for festival newsletter
        async function triggerFestivalNewsletter(festivalId) {
            try {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '‚è≥ Generating...';
                button.disabled = true;
                
                const response = await fetch(`${API_BASE_URL}/api/newsletter/send-festival-newsletter`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shopDomain: SHOP_DOMAIN,
                        festivalId: festivalId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`‚úÖ Newsletter sent successfully to ${result.emailsSent} subscribers!`, 'success');
                    // Reload auto-newsletter status to show the new newsletter
                    loadAutoNewsletterStatus();
                } else {
                    showMessage(`‚ùå Failed to send newsletter: ${result.error}`, 'error');
                }
                
                button.innerHTML = originalText;
                button.disabled = false;
                
            } catch (error) {
                console.error('Error triggering festival newsletter:', error);
                showMessage('‚ùå Error triggering newsletter. Please try again.', 'error');
                
                const button = event.target;
                button.innerHTML = button.innerHTML.replace('‚è≥ Generating...', 'üìß Send Newsletter');
                button.disabled = false;
            }
        }

        // Regional Preview Functions
        function showRegionalPreview() {
            const modal = document.getElementById('regional-preview-modal');
            modal.style.display = 'flex';
        }

        function closeRegionalPreview() {
            const modal = document.getElementById('regional-preview-modal');
            modal.style.display = 'none';
            document.getElementById('preview-state-selector').value = '';
            document.getElementById('regional-preview-content').innerHTML = '<p style="color: #999;">Select a state to see regional variations</p>';
        }

        async function updateRegionalPreview() {
            const selectedState = document.getElementById('preview-state-selector').value;
            const loadingIndicator = document.getElementById('preview-loading');
            const previewContent = document.getElementById('regional-preview-content');

            if (!selectedState) {
                previewContent.innerHTML = '<p style="color: #999;">Select a state to see regional variations</p>';
                return;
            }

            loadingIndicator.style.display = 'inline';
            previewContent.innerHTML = '<p style="color: #666;">Loading regional preview...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/location/festival/${SHOP_DOMAIN}?state=${encodeURIComponent(selectedState)}`);
                const data = await response.json();

                if (data.success) {
                    const festival = data.festival;
                    
                    previewContent.innerHTML = `
                        <div style="max-width: 600px; margin: 0 auto;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">
                                ${selectedState} Variation
                            </h3>
                            
                            <div style="background: linear-gradient(135deg, ${festival.backgroundColor || '#667eea'}, ${festival.headerColor || '#764ba2'}); 
                                        border-radius: 15px; padding: 30px; color: white; margin-bottom: 20px; position: relative; overflow: hidden;">
                                
                                ${festival.backgroundImageUrl ? `
                                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                                                background-image: url('${festival.backgroundImageUrl}'); 
                                                background-size: cover; background-position: center; 
                                                opacity: 0.3; z-index: 0;"></div>
                                ` : ''}
                                
                                <div style="position: relative; z-index: 1;">
                                    <h2 style="color: ${festival.textColor || '#ffffff'}; margin: 0 0 10px 0; font-size: 24px;">
                                        ${festival.name} Special!
                                    </h2>
                                    
                                    <div style="color: ${festival.textColor || '#ffffff'}; font-size: 32px; font-weight: bold; margin: 10px 0;">
                                        ${festival.offer.match(/(\d+%)/)?.[1] || '50%'} OFF
                                    </div>
                                    
                                    <div style="color: ${festival.textColor || '#ffffff'}; margin: 10px 0;">
                                        Use code at checkout
                                    </div>
                                    
                                    <div style="background: rgba(255,255,255,0.9); color: #000; padding: 10px 20px; 
                                                border-radius: 8px; font-weight: bold; display: inline-block; margin: 10px 0;">
                                        ${festival.discountCode}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="text-align: left;">
                                ${festival.isRegionallyCustomized ? `
                                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                        <h4 style="color: #2d5016; margin: 0 0 10px 0;">‚úÖ Regional Customization Active</h4>
                                        <p style="color: #2d5016; margin: 5px 0;"><strong>Original:</strong> ${festival.originalName}</p>
                                        <p style="color: #2d5016; margin: 5px 0;"><strong>Regional:</strong> ${festival.name}</p>
                                        <p style="color: #2d5016; margin: 5px 0;"><strong>Region:</strong> ${festival.region}</p>
                                    </div>
                                ` : `
                                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                        <h4 style="color: #856404; margin: 0 0 10px 0;">‚ÑπÔ∏è Default Festival</h4>
                                        <p style="color: #856404; margin: 5px 0;">No specific regional customization available for this festival in ${selectedState}</p>
                                    </div>
                                `}
                                
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <h4 style="color: #495057; margin: 0 0 10px 0;">Festival Details</h4>
                                    <p style="color: #495057; margin: 5px 0;"><strong>Offer:</strong> ${festival.offer}</p>
                                    <p style="color: #495057; margin: 5px 0;"><strong>Discount Code:</strong> ${festival.discountCode}</p>
                                    <p style="color: #495057; margin: 5px 0;"><strong>Background:</strong> ${festival.backgroundImageUrl ? 'Custom AI-generated image' : 'Gradient background'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    previewContent.innerHTML = `
                        <div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 8px;">
                            <h4>No Active Festival</h4>
                            <p>${data.message || 'No festivals are currently active for preview.'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error fetching regional preview:', error);
                previewContent.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 8px;">
                        <h4>Preview Error</h4>
                        <p>Could not load regional preview. Please check if you have an active festival configured.</p>
                    </div>
                `;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
    </script>
</body>
</html> 